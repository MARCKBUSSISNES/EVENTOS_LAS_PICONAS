<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Sistema Offline - Las Piconas (Touch)</title>
<style>
:root{--bg:#0b0f14;--panel:#0f1720;--card:#0b1220;--accent:#ff6b35;--muted:#9aa4b2;--glass:rgba(255,255,255,0.03);}
*{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#06080a 0%, #0b0f14 100%);color:#e6eef6;}
.app{display:grid;grid-template-columns:360px 1fr 360px;gap:14px;padding:14px;height:100vh;}
.sidebar{background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
.brand{font-weight:800;letter-spacing:0.6px;padding:8px 12px;font-size:18px;text-align:center;color:#fff;}
.logo-preview{max-width:140px;margin:6px auto 8px;display:block;}
.controls-row{display:flex;gap:8px;margin-bottom:8px;}
.input, .qty{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:8px;color:#e6eef6;}
.categorias{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.cat-btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;font-weight:700;min-width:80px;}
.products{margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;overflow:auto;padding:6px;height:calc(100vh - 420px);}
.prod-btn{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:10px;cursor:pointer;text-align:center;user-select:none;color:#fff;}
.prod-name{font-weight:800;}
.prod-price{font-size:13px;color:var(--muted);margin-top:6px;}
.center{background:var(--card);border-radius:12px;padding:12px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
.viewer{flex:1;background:linear-gradient(180deg,#071428,#071a2a);padding:12px;border-radius:10px;overflow:auto;}
.item-row{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);}
.item-actions{display:flex;gap:6px;}
.action-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:6px 8px;border-radius:8px;cursor:pointer;}
.controls{display:flex;gap:8px;margin-top:10px;}
.control-btn{flex:1;padding:12px;border-radius:8px;background:var(--accent);color:#0b1220;font-weight:800;border:none;cursor:pointer;}
.small{padding:8px;font-size:14px;}
.right{background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
.summary{background:linear-gradient(180deg,#071428,#071a2a);border-radius:10px;padding:12px;margin-bottom:12px;}
.kv{display:flex;justify-content:space-between;color:var(--muted);padding:6px 0;}
.history{flex:1;overflow:auto;}
.row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);}
.footer{font-size:12px;color:var(--muted);text-align:center;margin-top:8px;}
.big-btn{background:linear-gradient(90deg,#111827,#0b1220);border:2px solid rgba(255,255,255,0.04);color:#fff;padding:12px;border-radius:10px;font-weight:800;}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.current-order{font-size:20px;font-weight:900;text-align:center;}
.cat-MEDIANAS{background:#0f4bff;}
.cat-JUMBOS{background:#16a34a;}
.cat-TACOS{background:#7c3aed;}
.cat-BEBIDAS{background:#f97316;}
.cat-POSTRES_Y_EXTRAS{background:#ef4444;}
.cat-MEDIANAS,.cat-JUMBOS,.cat-TACOS,.cat-BEBIDAS,.cat-POSTRES_Y_EXTRAS{color:#fff;padding:8px;border-radius:8px;border:none;}
@media print{body *{visibility:hidden}.print-area, .print-area *{visibility:visible}.print-area{position:fixed;left:0;top:0;width:100%}}
.login-wrap{position:fixed;inset:0;background:linear-gradient(90deg, rgba(2,6,23,0.9), rgba(4,10,27,0.95));display:flex;align-items:center;justify-content:center;z-index:999;}
.login-card{background:linear-gradient(180deg,#071428,#0b1220);padding:28px;border-radius:12px;min-width:360px;box-shadow:0 8px 30px rgba(2,6,23,0.7);color:#fff;}
.login-card h2{text-align:center;margin:6px 0 12px;}
.login-card .input{width:100%;margin-bottom:10px;}
.login-logo{max-width:140px;display:block;margin:0 auto 10px;}
/* small helper to mark active pay button without changing design */
.pay-active{outline:2px solid rgba(255,255,255,0.08);box-shadow:0 4px 12px rgba(0,0,0,0.4) inset;}
/* inline comment input styling in viewer — subtle to keep original look */
.comment-input{background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:6px;border-radius:6px;color:#e6eef6;font-size:13px;min-width:140px}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="login-wrap">
  <div class="login-card">
    <img src="logo" class="login-logo" onerror="this.onerror=null;this.src='logo.png';" />
    <h2>Ingreso al Sistema</h2>
    <input id="user" class="input" placeholder="Usuario" value="" />
    <input id="pass" class="input" placeholder="Clave" type="password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnLogin" class="big-btn" style="flex:1">Entrar</button>
    </div>
    <div style="text-align:center;margin-top:10px;color:var(--muted);font-size:13px">
      Usuario: <b>CAJERO</b> — Clave: <b>123</b>
    </div>
  </div>
</div>

<div class="app" id="appRoot" style="display:none;">
  <div class="sidebar">
    <div class="brand">Las Piconas - Punto de Venta (Touch)</div>
    <img src="logo" alt="logo" class="logo-preview" onerror="this.onerror=null;this.src='logo.png';" />
    
    <!-- BOTONES NUEVAS CATEGORIAS / PRODUCTOS -->
    <div style="margin-top:12px">
      <button id="btnAddCategory" class="big-btn" style="margin-bottom:6px">+ Nueva Categoría</button>
      <button id="btnAddProduct" class="big-btn">+ Nuevo Producto</button>
    </div>

    <div class="controls-row">
      <input id="qty" class="qty" type="number" value="1" min="1" style="flex:1" />
      <button id="btnDeleteLast" class="action-btn">Borrar último</button>
    </div>

    <div style="margin-top:6px">
      <div style="font-size:13px;color:var(--muted);padding:6px">Categorías</div>
      <div class="categorias" id="categorias"></div>
    </div>

    <div style="margin-top:12px">
      <div style="font-size:13px;color:var(--muted);padding:6px">Productos</div>
      <div class="products" id="products"></div>
    </div>
  </div>

  <div class="center">
    <div class="topbar">
      <div style="font-weight:800;font-size:18px">Visor de Cliente</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btn-cash" class="action-btn">Efectivo</button>
        <button id="btn-card" class="action-btn">Tarjeta</button>
        <!-- Comentario general de comanda (integrado discreto, sin cambiar diseño) -->
        <input id="generalComment" placeholder="Comentario general (opcional)" class="input" style="width:260px;margin-left:8px" />
      </div>
    </div>
    <div class="current-order" id="currentOrder">Orden: A 1</div>
    <div class="viewer" id="viewer"></div>
    <div class="controls">
      <button id="minus" class="action-btn small">-</button>
      <button id="plus" class="action-btn small">+</button>
      <button id="coupon" class="action-btn small">Descuento Q</button>
      <button id="finalizar" class="control-btn">Cobrar & Generar Tickets</button>
    </div>
  </div>

  <div class="right">
    <div class="summary">
      <div class="kv"><div>Subtotal</div><div id="subtotal">Q0.00</div></div>
      <div class="kv"><div>Descuento</div><div id="discount">Q0.00</div></div>
      <div class="kv" style="font-weight:800;margin-top:8px"><div>Total</div><div id="total">Q0.00</div></div>
    </div>

    <div style="margin-bottom:8px">
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Historial / Reimprimir</div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="searchId" class="input" placeholder="Buscar por id u orden..." />
        <button id="btnSearch" class="action-btn">Buscar</button>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="btnCloseShift" class="big-btn" style="flex:1;background:linear-gradient(90deg,#7c3aed,#6d28d9)">Cierre de Turno</button>
        <button id="btnExport" class="action-btn">Exportar</button>
      </div>
      <div class="history" id="history"></div>
    </div>
    <div class="footer">Powered by Marck Business - Tecnología para tu negocio</div>
  </div>
</div>

<script>
// --- Datos iniciales (mantiene tu estructura y persistencia) ---
let CATEGORIES = JSON.parse(localStorage.getItem('categories_v3')) || {
  'MEDIANAS': [{name:'MED. POLLO', price:35},{name:'MED. PASTOR', price:35},{name:'MED. MIXTA', price:35}],
  'JUMBOS': [{name:'JUMB. POLLO', price:55},{name:'JUMB. PASTOR', price:55}],
  'TACOS': [{name:'TACOS POLLO', price:35},{name:'TACOS PASTOR', price:35}],
  'BEBIDAS': [{name:'AGUA PURA', price:10},{name:'COCA COLA', price:15}],
  'POSTRES_Y_EXTRAS': [{name:'CINAMON ROLL', price:20},{name:'ARROZ EN LECHE', price:20}]
};

let cart = [];
let discount = 0;
let paymentMethod = 'EFECTIVO';

// Correlativo perpetuo (persistente). Se guarda como número, pero el label es "A {n}".
// Si no existe, inicia en 1 para producir A1.
let orderCounter = Number(localStorage.getItem('order_counter') || 1);
function currentOrderLabel(){ return `A ${orderCounter}`; }
function getOrderId(){ return `A${orderCounter}`; } // para ID compacto (A1)
function bumpOrderCounter(){ orderCounter = orderCounter + 1; localStorage.setItem('order_counter', orderCounter); updateCurrentOrderUI(); }
function updateCurrentOrderUI(){ document.getElementById('currentOrder').textContent = 'Orden: ' + currentOrderLabel(); }

// helpers
const fmt = v=> 'Q'+(Number(v)||0).toFixed(2);
function recalc(){ const subtotal = cart.reduce((s,i)=>s + i.price*i.qty,0); const total = Math.max(0, subtotal - discount); document.getElementById('subtotal').textContent = fmt(subtotal); document.getElementById('discount').textContent = fmt(discount); document.getElementById('total').textContent = fmt(total); }

// RENDER
function renderCategories(){ const el=document.getElementById('categorias'); el.innerHTML=''; Object.keys(CATEGORIES).forEach(cat=>{ const b=document.createElement('button'); b.className='cat-btn cat-'+cat; b.textContent=cat; b.onclick=()=>showProducts(cat); el.appendChild(b); }); }
function showProducts(cat){ const el=document.getElementById('products'); el.innerHTML=''; CATEGORIES[cat].forEach(p=>{ const b=document.createElement('button'); b.className='prod-btn'; b.innerHTML=`<div class='prod-name'>${p.name}</div><div class='prod-price'>${fmt(p.price)}</div>`; b.onclick=()=> addProductWithCommentPrompt(p); el.appendChild(b); }); }
function renderViewer(){ updateCurrentOrderUI(); const v=document.getElementById('viewer'); v.innerHTML=''; cart.forEach((it,i)=>{ const row=document.createElement('div'); row.className='item-row'; 
  // construct name + inline comment input (editable)
  const left = document.createElement('div'); left.style.flex='1';
  left.innerHTML = `<div style="font-weight:800">${it.qty} x ${escapeHtml(it.name)}</div>`;
  const commentInput = document.createElement('input');
  commentInput.className = 'comment-input';
  commentInput.placeholder = 'Comentario (ej. sin cebolla)';
  commentInput.value = it.comment || '';
  commentInput.addEventListener('input', (e)=>{ cart[i].comment = e.target.value; persistWorkingCart(); });
  left.appendChild(commentInput);
  const right = document.createElement('div'); right.style.width='140px'; right.style.textAlign='right';
  right.innerHTML = `${fmt(it.price*it.qty)}<div style="margin-top:6px;display:flex;gap:6px;justify-content:flex-end"><button class="action-btn" data-idx="${i}" data-act="minus">-</button><button class="action-btn" data-idx="${i}" data-act="plus">+</button><button class="action-btn" style="background:#e74c3c" data-idx="${i}" data-act="del">X</button></div>`;
  row.appendChild(left); row.appendChild(right); v.appendChild(row);
});
// attach quantity/delete handlers
Array.from(document.querySelectorAll('button[data-act]')).forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    const idx = Number(btn.getAttribute('data-idx'));
    const act = btn.getAttribute('data-act');
    if(act === 'minus'){ if(cart[idx].qty>1) cart[idx].qty--; else cart.splice(idx,1); }
    else if(act === 'plus'){ cart[idx].qty++; }
    else if(act === 'del'){ cart.splice(idx,1); }
    renderViewer();
  });
});
recalc();
}
function saveCategories(){ localStorage.setItem('categories_v3', JSON.stringify(CATEGORIES)); }

// CART: when adding, ask for optional comment but also allow inline edit later
function addProductWithCommentPrompt(p){
  const qty = Number(document.getElementById('qty').value) || 1;
  const comment = ''; // sin comentario automático
  const existing = cart.find(c => c.name === p.name && (c.comment || '') === comment);
  if (existing) { 
    existing.qty += qty; 
  } else { 
    cart.push({ name: p.name, price: p.price, qty, comment }); 
  }
  persistWorkingCart();
  renderViewer();
}
Viewer();
}
function persistWorkingCart(){
  // only persist the categories and working cart if needed; we persist final sales separately
  localStorage.setItem('current_cart_working', JSON.stringify(cart));
}

// EVENTOS
document.getElementById('btnAddCategory').onclick = ()=>{
  const name = prompt('Nombre de la nueva categoría:');
  if(name){ CATEGORIES[name]=[]; saveCategories(); renderCategories(); }
};
document.getElementById('btnAddProduct').onclick = ()=>{
  const cat = prompt('Categoría del producto:'); if(!cat){ alert('Ingrese categoría'); return; }
  if(!CATEGORIES[cat]){ alert('Categoría no existe'); return; }
  const name = prompt('Nombre del producto:'); if(!name){ alert('Ingrese nombre'); return; }
  const price = parseFloat(prompt('Precio del producto:')); if(isNaN(price)){ alert('Precio inválido'); return; }
  CATEGORIES[cat].push({name,price}); saveCategories(); showProducts(cat);
};
document.getElementById('plus').onclick = ()=>{ document.getElementById('qty').stepUp(); }
document.getElementById('minus').onclick = ()=>{ document.getElementById('qty').stepDown(); }
document.getElementById('btnDeleteLast').onclick = ()=>{
  if(cart.length>0){ cart.pop(); persistWorkingCart(); renderViewer(); }
};
document.getElementById('coupon').onclick = ()=>{
  const d = parseFloat(prompt('Ingrese descuento Q')); if(!isNaN(d)){ discount=d; recalc(); }
};

// payment buttons - marcan método y resaltan activamente (pequeño efecto, manteniendo diseño)
const btnCash = document.getElementById('btn-cash');
const btnCard = document.getElementById('btn-card');
function setPaymentMethod(m){
  paymentMethod = (m||'EFECTIVO').toUpperCase();
  btnCash.classList.toggle('pay-active', paymentMethod === 'EFECTIVO');
  btnCard.classList.toggle('pay-active', paymentMethod === 'TARJETA' || paymentMethod === 'CARD' || paymentMethod === 'CREDITO');
}
btnCash.addEventListener('click', ()=> setPaymentMethod('EFECTIVO'));
btnCard.addEventListener('click', ()=> setPaymentMethod('TARJETA'));
setPaymentMethod('EFECTIVO');

// FINALIZAR: guardar venta, generar combined print (venta + cocina) en un SOLO trabajo de impresión (para que la impresora corte entre ambos)
// luego limpiar carrito y avanzar correlativo
document.getElementById('finalizar').onclick = ()=>{
  if(cart.length==0){ alert('No hay productos'); return; }
  // Ensure we capture current inline comments (they are already bound to cart via input listeners)
  const sale = buildSaleObject();
  saveSale(sale);
  // print combined ticket: sale then page-break then kitchen
  printCombinedTicket(sale);
  // cleanup
  cart = [];
  discount = 0;
  persistWorkingCart();
  bumpOrderCounter();
  renderViewer();
  renderHistory();
  alert('Venta registrada y tickets generados');
};

// LOGIN
document.getElementById('btnLogin').onclick = ()=>{
  const u=document.getElementById('user').value; const p=document.getElementById('pass').value;
  if(u==='CAJERO' && p==='123'){ document.getElementById('login').style.display='none'; document.getElementById('appRoot').style.display='grid'; renderCategories(); updateCurrentOrderUI(); renderHistory(); renderViewer(); }else{ alert('Usuario o clave incorrecta'); }
};

// VENTAS: guardado y render historia con opciones de reimpresión
function buildSaleObject(){
  const idCompact = getOrderId(); // A1
  const idLabel = currentOrderLabel(); // A 1
  const dateObj = new Date();
  const dateStr = formatDateTime(dateObj);
  const subtotal = cart.reduce((s,i)=>s+i.qty*i.price,0);
  const total = Math.max(0, subtotal - discount);
  const generalComment = (document.getElementById('generalComment')||{value:''}).value || '';
  return {
    id: idCompact,
    label: idLabel,
    date: dateObj.toISOString(),
    dateFormatted: dateStr,
    items: cart.map(i=>({ name:i.name, qty:i.qty, price:i.price, comment:i.comment||''})),
    subtotal, discount, total,
    method: paymentMethod,
    generalComment
  };
}

function saveSale(sale){
  const history = JSON.parse(localStorage.getItem('sales_v3')||'[]');
  history.push(sale);
  localStorage.setItem('sales_v3', JSON.stringify(history));
  // Also store last printed to facilitate reprint actions
  localStorage.setItem('last_sale_id', sale.id);
}

// render history with click menu to reimprimir o ver detalle
function renderHistory(filter){
  const hist = JSON.parse(localStorage.getItem('sales_v3')||'[]');
  const el = document.getElementById('history'); el.innerHTML='';
  const list = (filter? hist.filter(h=> (h.id||'').toString().includes(filter) || (h.label||'').toString().includes(filter) ) : hist).slice().reverse();
  if(list.length===0){ el.innerHTML = '<div style="color:var(--muted);padding:8px">No hay ventas aún</div>'; return; }
  list.forEach(h=>{
    const div=document.createElement('div'); div.className='row';
    const left = document.createElement('div');
    left.innerHTML = `#${h.label} - <b>${fmt(h.total)}</b> (${escapeHtml(h.method)})<div style="font-size:12px;color:var(--muted)">${escapeHtml(h.dateFormatted)}</div>`;
    const right = document.createElement('div');
    // botones pequeños para reimprimir (manteniendo diseño)
    const btn1 = document.createElement('button'); btn1.className='action-btn'; btn1.textContent='Reimprimir Venta';
    const btn2 = document.createElement('button'); btn2.className='action-btn'; btn2.textContent='Reimprimir Cocina';
    const btn3 = document.createElement('button'); btn3.className='action-btn'; btn3.textContent='Detalles';
    btn1.onclick = (e)=>{ e.stopPropagation(); printSaleOnly(h); };
    btn2.onclick = (e)=>{ e.stopPropagation(); printKitchenOnly(h); };
    btn3.onclick = (e)=>{ e.stopPropagation(); openDetailModal(h); };
    right.appendChild(btn1); right.appendChild(btn2); right.appendChild(btn3);
    div.appendChild(left); div.appendChild(right);
    el.appendChild(div);
  });
}

// Buscar
document.getElementById('btnSearch').onclick = ()=>{
  const q=document.getElementById('searchId').value.trim();
  renderHistory(q);
};

// Exportar
document.getElementById('btnExport').onclick = ()=>{ const data=localStorage.getItem('sales_v3') || '[]'; const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ventas.json'; a.click(); }

// CIERRE DE TURNO -> imprime ticket de cierre con totales por forma AUTOMÁTICAMENTE y luego resetea si confirma
document.getElementById('btnCloseShift').onclick = ()=>{
  const code = prompt('Ingrese código de cierre:');
  if(code === null) return;
  if(code !== '1234'){ alert('Código incorrecto'); return; }
  const hist = JSON.parse(localStorage.getItem('sales_v3')||'[]');
  if(hist.length === 0){ alert('No hay ventas para cierre'); return; }
  // calcular
  let totalEfectivo = 0, totalTarjeta = 0, totalGeneral = 0;
  hist.forEach(h=>{
    if((h.method || '').toUpperCase().includes('EFECTIVO')) totalEfectivo += h.total;
    else totalTarjeta += h.total;
    totalGeneral += h.total;
  });
  const cierre = { date: new Date().toISOString(), totalEfectivo, totalTarjeta, totalGeneral, tickets: hist.map(h=>({ id: h.id, label: h.label, date: h.dateFormatted, total: h.total, method: h.method })) };
  printCloseTicket(cierre);
  // después de imprimir, preguntar si desea resetear datos
  if(confirm('¿Desea resetear (vaciar) el historial y reiniciar correlativo a A1?')) {
    localStorage.setItem('sales_v3','[]');
    localStorage.setItem('order_counter','1');
    orderCounter = 1;
    renderHistory();
    updateCurrentOrderUI();
    alert('Datos reseteados.');
  }
};

// UTILS: escape HTML
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function pad(n){ return n < 10 ? '0' + n : n; }
function formatDateTime(d){ return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }

// PRINTING: produce a single print job with sale + PAGE BREAK + kitchen so printer receives both in same job
function printCombinedTicket(ticket){
  const chefSVG = getChefSVGBase64();
  // ensure logo fallback: 'logo' or 'logo.png'
  const logoSrc = 'logo';
  const html = `
    <!doctype html>
    <html>
      <head><meta charset="utf-8"><title>Tickets ${escapeHtml(ticket.id)}</title>
        <style>
          @media print { @page { size: 80mm auto; margin: 3mm; } body{ -webkit-print-color-adjust: exact; } }
          body{font-family:Arial,Helvetica,sans-serif;padding:6px;margin:0;}
          .ticket{width:76mm;margin:0 auto;}
          .center{text-align:center;}
          img.logo{max-width:72mm;height:auto;display:block;margin:0 auto 6px;}
          img.chef{max-width:60mm;height:auto;display:block;margin:0 auto 6px;}
          .company{font-weight:700;font-size:14px;}
          .muted{font-size:12px;color:#333;}
          .order{font-size:16px;font-weight:700;margin:6px 0;}
          table{width:100%;border-collapse:collapse;font-size:12px;}
          th,td{padding:4px;text-align:left;}
          .price{text-align:right;}
          .total{font-size:16px;font-weight:700;border-top:1px solid #000;padding-top:6px;margin-top:6px;}
          .item{padding:4px 0;font-size:13px;}
          .small{font-size:11px;}
          .page-break{page-break-after:always;break-after:page;height:8px;}
        </style>
      </head>
      <body onload="setTimeout(()=>{ window.print(); },200)">
        <!-- TICKET DE VENTA -->
        <div class="ticket">
          <img src="${logoSrc}" class="logo" onerror="this.onerror=null;this.src='logo.png';" />
          <div class="center company">TORTILLAS DE HARINA LAS PICONAS</div>
          <div class="center muted">EVENTOS</div>
          <div class="center muted">ENCUENTRANOS EN: ZONA 17, ROOSEVELT Y SAN CRISTOBAL</div>
          <div style="height:6px"></div>
          <div class="center muted">${escapeHtml(ticket.dateFormatted)}</div>
          <div class="order center">SU ORDEN ES &nbsp; <span style="font-size:20px">${escapeHtml(ticket.label)}</span></div>
          <div class="center" style="font-size:18px;font-weight:700">DETALLE DE CONSUMO</div>
          <table>
            <thead><tr><th>PRODUCTO</th><th class="price">PRECIO</th></tr></thead>
            <tbody>
              ${ticket.items.map(it=>`<tr><td>${it.qty} x ${escapeHtml(it.name)}</td><td class="price">Q${(it.price*it.qty).toFixed(2)}</td></tr>`).join('')}
            </tbody>
          </table>
          <div class="total">TOTAL &nbsp; Q${ticket.total.toFixed(2)}</div>
          <div style="margin-top:6px" class="small">Forma de pago: ${escapeHtml(ticket.method)}</div>
          ${ticket.generalComment? `<div class="small">Comentario: ${escapeHtml(ticket.generalComment)}</div>` : ''}
          <div style="margin-top:8px" class="center small">Gracias por su compra</div>
        </div>

        <div class="page-break"></div>

        <!-- COMANDA / COCINA (sin precios) -->
        <div class="ticket">
          <div class="center"><img src="${chefSVG}" class="chef" alt="Chef"/></div>
          <div class="center company">COCINA - COMANDA</div>
          <div class="center muted">${escapeHtml(ticket.dateFormatted)}</div>
          <div style="height:6px"></div>
          <div class="order center">ORDEN NO. <span style="font-size:20px">${escapeHtml(ticket.label)}</span></div>
          ${ticket.generalComment? `<div style="font-size:12px;color:#333;margin-bottom:6px">Comentario general: ${escapeHtml(ticket.generalComment)}</div>` : ''}
          <div>
            ${ticket.items.map(it=>`<div class="item">${it.qty} x ${escapeHtml(it.name)} ${it.comment?`<div style="font-size:11px;color:#333">(${escapeHtml(it.comment)})</div>` : ''}</div>`).join('')}
          </div>
          <div style="margin-top:8px" class="center small">--- FIN COMANDA ---</div>
        </div>
      </body>
    </html>
  `;
  const win = window.open('', '_blank', 'width=420,height=720');
  win.document.write(html);
  win.document.close();
  // close window after a delay (some printers block close) — we let user/print dialog control
}

// Functions to reprint only sale or only kitchen
function printSaleOnly(ticket){
  const logoSrc = 'logo';
  const html = `
    <!doctype html><html><head><meta charset="utf-8"><title>Venta ${escapeHtml(ticket.id)}</title>
      <style>@media print {@page{size:80mm auto;margin:3mm}} body{font-family:Arial;padding:6px} .ticket{width:76mm;margin:0 auto}.center{text-align:center}.company{font-weight:700}.price{text-align:right}.total{font-weight:700;margin-top:6px}</style>
    </head><body onload="setTimeout(()=>window.print(),200)">
      <div class="ticket">
        <img src="${logoSrc}" style="max-width:72mm;display:block;margin:0 auto 6px" onerror="this.onerror=null;this.src='logo.png';"/>
        <div class="center company">TORTILLAS DE HARINA LAS PICONAS</div>
        <div class="center">${escapeHtml(ticket.dateFormatted)}</div>
        <div class="center" style="font-weight:700;margin:6px 0">SU ORDEN ES ${escapeHtml(ticket.label)}</div>
        <table style="width:100%;font-size:12px">${ticket.items.map(it=>`<tr><td>${it.qty} x ${escapeHtml(it.name)}</td><td style="text-align:right">Q${(it.price*it.qty).toFixed(2)}</td></tr>`).join('')}</table>
        <div class="total">TOTAL Q${ticket.total.toFixed(2)}</div>
        <div style="margin-top:6px">Forma de pago: ${escapeHtml(ticket.method)}</div>
      </div>
    </body></html>
  `;
  const w = window.open('', '_blank', 'width=420,height=720'); w.document.write(html); w.document.close();
}
function printKitchenOnly(ticket){
  const chefSVG = getChefSVGBase64();
  const html = `
    <!doctype html><html><head><meta charset="utf-8"><title>Comanda ${escapeHtml(ticket.id)}</title>
      <style>@media print {@page{size:80mm auto;margin:3mm}} body{font-family:Arial;padding:6px} .ticket{width:76mm;margin:0 auto}.center{text-align:center}.item{padding:4px 0}</style>
    </head><body onload="setTimeout(()=>window.print(),200)">
      <div class="ticket">
        <div class="center"><img src="${chefSVG}" style="max-width:60mm;display:block;margin:0 auto 6px" /></div>
        <div class="center" style="font-weight:700">COCINA - COMANDA</div>
        <div class="center">${escapeHtml(ticket.dateFormatted)}</div>
        <div style="margin:6px 0;text-align:center;font-weight:700">ORDEN NO. ${escapeHtml(ticket.label)}</div>
        ${ticket.generalComment?`<div style="font-size:12px;margin-bottom:6px">Comentario general: ${escapeHtml(ticket.generalComment)}</div>`:''}
        <div>${ticket.items.map(it=>`<div class="item">${it.qty} x ${escapeHtml(it.name)} ${it.comment?`<div style="font-size:11px">(${escapeHtml(it.comment)})</div>`:''}</div>`).join('')}</div>
      </div>
    </body></html>
  `;
  const w = window.open('', '_blank', 'width=420,height=720'); w.document.write(html); w.document.close();
}

// Cierre de ventas ticket (resumen efectivo/tarjeta)
function printCloseTicket(cierre){
  const html = `
    <!doctype html><html><head><meta charset="utf-8"><title>Cierre</title>
    <style>@media print{@page{size:80mm auto;margin:3mm}} body{font-family:Arial;padding:6px}.ticket{width:76mm;margin:0 auto}.center{text-align:center}.total{font-weight:700}</style>
    </head><body onload="setTimeout(()=>window.print(),200)">
      <div class="ticket">
        <div class="center" style="font-weight:700">CIERRE DE VENTAS</div>
        <div class="center">${escapeHtml(new Date(cierre.date).toLocaleString())}</div>
        <div style="margin-top:8px">Total Efectivo: Q${cierre.totalEfectivo.toFixed(2)}</div>
        <div>Total Tarjeta: Q${cierre.totalTarjeta.toFixed(2)}</div>
        <div style="margin-top:6px;font-weight:700">Total General: Q${cierre.totalGeneral.toFixed(2)}</div>
        <div style="margin-top:8px;font-size:12px">Tickets incluidos:</div>
        <div style="font-size:12px">${cierre.tickets.map(t=>`${escapeHtml(t.label)} - ${escapeHtml(t.date)} - Q${t.total.toFixed(2)} - ${escapeHtml(t.method)}`).join('<br/>')}</div>
      </div>
    </body></html>
  `;
  const w = window.open('', '_blank', 'width=420,height=720'); w.document.write(html); w.document.close();
}

// Generador de SVG de cocinero (data URL) para encabezado de cocina
function getChefSVGBase64(){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 64 64'>
    <g fill='none' fill-rule='evenodd'>
      <circle cx='32' cy='22' r='10' fill='#FFD966'/>
      <path d='M20 38c0-7 12-10 12-10s12 3 12 10v10H20V38z' fill='#F4A261'/>
      <path d='M18 24c0-7.7 6.3-14 14-14s14 6.3 14 14' stroke='#333' stroke-width='0.8' fill='none'/>
      <path d='M24 20c1 1.5 3 2 4 0' stroke='#333' stroke-width='0.8' stroke-linecap='round'/>
      <path d='M40 20c-1 1.5-3 2-4 0' stroke='#333' stroke-width='0.8' stroke-linecap='round'/>
      <path d='M26 22c.8 1.2 2 1.6 3 1.6s2.2-.4 3-1.6' stroke='#333' stroke-width='0.8' stroke-linecap='round' stroke-linejoin='round'/>
      <path d='M36 10c0 0 4-6 12-4 6 1.5 6 6 6 8 0 0-2-2-6-2-4 0-11 2-12-2z' fill='#fff' stroke='#333' stroke-width='0.6'/>
    </g>
  </svg>`;
  return 'data:image/svg+xml;base64,' + btoa(svg);
}

// Detalle modal (simple - nueva ventana)
function openDetailModal(ticket){
  const w = window.open('', '_blank', 'width=480,height=640');
  let html = `<html><head><meta charset="utf-8"><title>Detalle ${escapeHtml(ticket.label)}</title></head><body style="font-family:Arial,Helvetica,sans-serif;padding:12px">`;
  html += `<h3>Detalle ${escapeHtml(ticket.label)}</h3>`;
  html += `<div>Fecha: ${escapeHtml(ticket.dateFormatted)}</div>`;
  html += `<div>Forma: ${escapeHtml(ticket.method)}</div>`;
  html += `<div>Comentario: ${escapeHtml(ticket.generalComment || '')}</div>`;
  html += `<ul>`;
  ticket.items.forEach(it => { html += `<li>${it.qty} x ${escapeHtml(it.name)} - Q${(it.price*it.qty).toFixed(2)}${it.comment?` - (${escapeHtml(it.comment)})`:''}</li>`; });
  html += `</ul><div><strong>Total: ${fmt(ticket.total)}</strong></div>`;
  html += `</body></html>`;
  w.document.write(html);
  w.document.close();
}

// On load: render categories, history and UI
function init(){
  // restore working cart if any
  try{
    const working = JSON.parse(localStorage.getItem('current_cart_working') || '[]');
    if(Array.isArray(working) && working.length) cart = working;
  }catch(e){ cart = []; }
  renderCategories();
  renderHistory();
  renderViewer();
  updateCurrentOrderUI();
}
init();
</script>

</body>
</html>

