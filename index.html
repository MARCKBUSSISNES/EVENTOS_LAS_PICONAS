<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantilla HTML - Factura y Comanda (80mm)</title>
  <style>
    /* Mantener estilo original y añadir estilos para 80mm */
    :root{font-family: Arial, Helvetica, sans-serif;color:#222}
    body{margin:0;padding:20px;background:#f6f7fb}
    .container{max-width:900px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:14px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}
    .card{background:#fafafd;padding:12px;border-radius:6px;border:1px solid #eee}
    label{display:block;margin:8px 0 4px;font-weight:600;font-size:13px}
    input,select,button,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;font-size:14px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    .text-right{text-align:right}
    .total{font-size:18px;font-weight:700}
    .small{font-size:12px;color:#666}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .product-list{max-height:300px;overflow:auto}
    .cart-item{display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px dashed #eee}
    .cart-item .name{flex:1}
    .muted{color:#666;font-size:13px}

    /* Print / 80mm ticket styling (used in the generated ticket window) */
    @media print {
      @page { size: 80mm auto; margin: 0; }
      body { margin: 0; }
    }

    /* helper for small-ticket preview inside UI */
    .ticket-preview{background:#fff;border:1px solid #ccc;padding:8px;max-height:420px;overflow:auto}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .inline{display:inline-block}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Plantilla HTML: Añadir productos & generar factura</h1>
      <div class="small">Dos tickets: Venta (cliente) y Cocina (comanda). Impresión 80mm.</div>
    </header>

    <div class="grid">
      <!-- IZQUIERDA: Productos y carrito -->
      <div>
        <div class="card">
          <label>Agregar producto</label>
          <div class="row">
            <input id="prodName" placeholder="Nombre producto (ej. TACOS RES)" />
            <input id="prodQty" type="number" min="1" value="1" />
            <input id="prodPrice" type="number" min="0" step="0.01" value="0.00" />
          </div>
          <label>Comentario por producto (opcional)</label>
          <input id="prodComment" placeholder="Ej: sin cebolla, extra salsas" />
          <div style="margin-top:8px" class="row">
            <button id="btnAdd" style="background:#2d9cdb;color:white">AGREGAR AL CARRITO</button>
            <button id="btnClear" style="background:#eee">LIMPIAR</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <label>Carrito / FACTURA</label>
          <div id="cartList" class="product-list"></div>

          <label style="margin-top:8px">Comentario general de comanda</label>
          <input id="generalComment" placeholder="Ej: Mesa 3, para llevar, urgente..." />

          <label style="margin-top:8px">Forma de pago</label>
          <select id="paymentMethod">
            <option value="Efectivo">Efectivo</option>
            <option value="Tarjeta">Tarjeta</option>
          </select>

          <div style="margin-top:10px" class="row">
            <button id="btnPrintSale" style="background:#2ecc71;color:white">IMPRIMIR TICKET VENTA</button>
            <button id="btnPrintKitchen" style="background:#f39c12;color:white">IMPRIMIR COMANDA (COCINA)</button>
          </div>

          <div style="margin-top:8px" class="row">
            <button id="btnSaveOnly" style="background:#3498db;color:white">GUARDAR SIN IMPRIMIR</button>
            <button id="btnReprint" style="background:#9b59b6;color:white">REIMPRIMIR SELECCIONADO</button>
          </div>
        </div>

      </div>

      <!-- DERECHA: Historial / reimpresiones / cierre -->
      <div>
        <div class="card">
          <label>Correlativo (perpetuo)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="correlativeDisplay" class="total">A1</div>
            <button id="btnResetCorrel" style="background:#eee">Reiniciar a A1</button>
          </div>

          <label style="margin-top:12px">Tickets guardados (reimpresión)</label>
          <div id="ticketsList" style="max-height:260px;overflow:auto;border:1px solid #eee;padding:8px"></div>

          <div style="margin-top:12px" class="actions">
            <button id="btnOpenLastSale" style="background:#2d9cdb;color:white">Abrir última venta</button>
            <button id="btnOpenLastKitchen" style="background:#f39c12;color:white">Abrir última comanda</button>
          </div>

          <div style="margin-top:12px">
            <label>Cierre de ventas</label>
            <div class="muted">Genera ticket de cierre con totales por forma de pago y listado resumido.</div>
            <div style="margin-top:8px" class="row">
              <button id="btnCloseShift" style="background:#e74c3c;color:white">CIERRE DE VENTAS</button>
              <button id="btnExport" style="background:#eee">EXPORTAR JSON</button>
            </div>
          </div>

        </div>

        <div class="card" style="margin-top:12px">
          <label>Vista previa (no formato final)</label>
          <div id="preview" class="ticket-preview small"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    /* ======= Estructura y persistencia ======= */
    const STORAGE_KEYS = {
      NEXT_COUNTER: 'piconas_next_counter', // número entero, inicia en 1
      TICKETS: 'piconas_tickets' // array de tickets guardados
    };

    // Cargar siguiente número (inicia en 1)
    function getNextNumber(){
      let n = parseInt(localStorage.getItem(STORAGE_KEYS.NEXT_COUNTER) || '1', 10);
      if(isNaN(n) || n < 1) n = 1;
      return n;
    }
    function setNextNumber(n){ localStorage.setItem(STORAGE_KEYS.NEXT_COUNTER, String(n)); }
    // Correlativo: 'A' + número
    function nextCorrelative(){
      let n = getNextNumber();
      const ticketId = `A${n}`;
      setNextNumber(n+1);
      return ticketId;
    }

    function resetCorrelative(){
      setNextNumber(1);
      updateCorrelativeDisplay();
    }

    // Tickets storage
    function loadTickets(){ return JSON.parse(localStorage.getItem(STORAGE_KEYS.TICKETS) || '[]'); }
    function saveTickets(arr){ localStorage.setItem(STORAGE_KEYS.TICKETS, JSON.stringify(arr)); }

    // Inicializar si no existe
    if(!localStorage.getItem(STORAGE_KEYS.NEXT_COUNTER)){
      setNextNumber(1); // comienza en 1 -> A1
    }

    /* ======= UI references ======= */
    const prodName = document.getElementById('prodName');
    const prodQty = document.getElementById('prodQty');
    const prodPrice = document.getElementById('prodPrice');
    const prodComment = document.getElementById('prodComment');
    const btnAdd = document.getElementById('btnAdd');
    const btnClear = document.getElementById('btnClear');
    const cartList = document.getElementById('cartList');
    const generalComment = document.getElementById('generalComment');
    const paymentMethod = document.getElementById('paymentMethod');
    const btnPrintSale = document.getElementById('btnPrintSale');
    const btnPrintKitchen = document.getElementById('btnPrintKitchen');
    const btnSaveOnly = document.getElementById('btnSaveOnly');
    const btnReprint = document.getElementById('btnReprint');
    const ticketsList = document.getElementById('ticketsList');
    const preview = document.getElementById('preview');
    const correlativeDisplay = document.getElementById('correlativeDisplay');
    const btnResetCorrel = document.getElementById('btnResetCorrel');
    const btnCloseShift = document.getElementById('btnCloseShift');
    const btnExport = document.getElementById('btnExport');
    const btnOpenLastSale = document.getElementById('btnOpenLastSale');
    const btnOpenLastKitchen = document.getElementById('btnOpenLastKitchen');

    /* ======= Carrito en memoria (temporal antes de guardar) ======= */
    let cart = [];

    function addToCart(name, qty, price, comment){
      name = (name||'').toString().trim();
      if(!name) return alert('Ingrese nombre de producto');
      qty = Number(qty) || 1;
      price = Number(price) || 0.00;
      comment = (comment||'').toString().trim();
      cart.push({ name, qty, price, comment });
      renderCart();
    }

    function removeCartItem(index){
      cart.splice(index,1);
      renderCart();
    }

    function clearCart(){
      cart = [];
      renderCart();
    }

    function renderCart(){
      cartList.innerHTML = '';
      if(cart.length === 0){
        cartList.innerHTML = '<div class="muted">Carrito vacío</div>';
      } else {
        cart.forEach((it, idx) => {
          const row = document.createElement('div');
          row.className = 'cart-item';
          row.innerHTML = `
            <div class="qty muted">${it.qty} x</div>
            <div class="name">${escapeHtml(it.name)}${it.comment?` <div class="muted" style="font-size:12px">(${escapeHtml(it.comment)})</div>`:''}</div>
            <div class="price text-right muted">Q${(it.price).toFixed(2)}</div>
            <div style="width:40px"><button data-idx="${idx}" class="btnRemove" style="background:#e74c3c;color:white">X</button></div>
          `;
          cartList.appendChild(row);
        });
        // attach remove handlers
        Array.from(document.getElementsByClassName('btnRemove')).forEach(btn=>{
          btn.addEventListener('click', e=>{
            const idx = Number(btn.getAttribute('data-idx'));
            removeCartItem(idx);
          });
        });
      }
      updatePreview();
    }

    function escapeHtml(s){
      return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    /* ======= Form actions ======= */
    btnAdd.addEventListener('click', ()=>{
      addToCart(prodName.value, prodQty.value, prodPrice.value, prodComment.value);
      prodName.value=''; prodQty.value=1; prodPrice.value='0.00'; prodComment.value='';
    });
    btnClear.addEventListener('click', ()=>{ prodName.value=''; prodQty.value=1; prodPrice.value='0.00'; prodComment.value=''; });

    // Guardar ticket sin imprimir
    btnSaveOnly.addEventListener('click', ()=>{
      if(cart.length===0) return alert('Carrito vacío');
      const ticket = buildTicketObject();
      saveTicket(ticket);
      clearCart();
      generalComment.value='';
      updateTicketsList();
      alert('Ticket guardado correctamente (sin imprimir).');
    });

    // Imprimir venta (cliente) + guardar
    btnPrintSale.addEventListener('click', ()=>{
      if(cart.length===0) return alert('Carrito vacío');
      const ticket = buildTicketObject();
      saveTicket(ticket);
      printSaleTicket(ticket);
      clearCart();
      generalComment.value='';
      updateTicketsList();
    });

    // Imprimir cocina (comanda) + guardar
    btnPrintKitchen.addEventListener('click', ()=>{
      if(cart.length===0) return alert('Carrito vacío');
      const ticket = buildTicketObject();
      saveTicket(ticket);
      printKitchenTicket(ticket);
      clearCart();
      generalComment.value='';
      updateTicketsList();
    });

    // Reimprimir: selecciona primero en la lista a la izquierda y reimprime (o toma última)
    btnReprint.addEventListener('click', ()=>{
      const sel = document.querySelector('input[name="ticket_radio"]:checked');
      let tickets = loadTickets();
      if(!sel){
        if(tickets.length===0) return alert('No hay tickets para reimprimir.');
        // reimprime el último guardado
        const last = tickets[tickets.length-1];
        if(last.type === 'sale') printSaleTicket(last);
        else printKitchenTicket(last);
        return;
      }
      const id = sel.value;
      const t = tickets.find(x=>x.id === id);
      if(!t) return alert('Ticket no encontrado.');
      if(t.type === 'sale') printSaleTicket(t);
      else printKitchenTicket(t);
    });

    // Abrir última venta / comanda
    btnOpenLastSale.addEventListener('click', ()=>{
      const tickets = loadTickets().filter(t=>t.type==='sale');
      if(!tickets.length) return alert('No hay ventas guardadas.');
      openTicketDetails(tickets[tickets.length-1]);
    });
    btnOpenLastKitchen.addEventListener('click', ()=>{
      const tickets = loadTickets().filter(t=>t.type==='kitchen');
      if(!tickets.length) return alert('No hay comandas guardadas.');
      openTicketDetails(tickets[tickets.length-1]);
    });

    // Reiniciar correlativo a A1 (advertencia)
    btnResetCorrel.addEventListener('click', ()=>{
      if(confirm('¿Reiniciar correlativo a A1? Esto puede causar duplicados en su historial si no lo maneja con cuidado.')) resetCorrelative();
    });

    /* ======= Cierre de ventas ======= */
    btnCloseShift.addEventListener('click', ()=>{
      const tickets = loadTickets().filter(t=>t.type === 'sale');
      if(tickets.length === 0) return alert('No hay ventas para el cierre.');
      // calcular totales por forma
      let totalEfectivo = 0, totalTarjeta = 0, totalGeneral = 0;
      tickets.forEach(t=>{
        if(t.paymentMethod === 'Efectivo') totalEfectivo += t.total;
        else totalTarjeta += t.total;
        totalGeneral += t.total;
      });
      const cierre = {
        id: `CIERRE-${Date.now()}`,
        date: new Date().toISOString(),
        totalEfectivo, totalTarjeta, totalGeneral,
        tickets: tickets.map(t=> ({ id: t.id, date: t.dateFormatted, total: t.total, paymentMethod: t.paymentMethod }) )
      };
      printCloseTicket(cierre);
    });

    // Exportar JSON de todos los tickets
    btnExport.addEventListener('click', ()=>{
      const tickets = loadTickets();
      const blob = new Blob([JSON.stringify(tickets, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tickets_piconas_export.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    /* ======= Construcción de ticket objeto ======= */
    function buildTicketObject(){
      const id = nextCorrelative();
      const now = new Date();
      const t = {
        id, // A1, A2...
        number: parseInt(id.replace(/^A/,''),10),
        prefix: 'A',
        date: now.toISOString(),
        dateFormatted: formatDateTime(now),
        items: JSON.parse(JSON.stringify(cart)), // copia
        generalComment: generalComment.value || '',
        paymentMethod: paymentMethod.value,
        total: cart.reduce((s,i) => s + (i.qty * i.price), 0),
        type: 'sale' // tipo base sale; we will also save a kitchen version when needed
      };
      // Also create corresponding kitchen record (type='kitchen') if needed when printing kitchen
      return t;
    }

    /* ======= Guardar ticket (sale + kitchen variant) ======= */
    function saveTicket(ticket){
      const tickets = loadTickets();
      // Save sale ticket as type 'sale'
      tickets.push(ticket);

      // Also create a kitchen-only variant (without prices) to store as separate 'kitchen' type
      const kitchen = {
        ...ticket,
        id: ticket.id + '-K', // e.g. A1-K
        type: 'kitchen',
        items: ticket.items.map(it => ({ name: it.name, qty: it.qty, comment: it.comment }))
      };
      tickets.push(kitchen);

      saveTickets(tickets);
    }

    /* ======= UI Tickets list (reimpresión) ======= */
    function updateTicketsList(){
      const tickets = loadTickets();
      ticketsList.innerHTML = '';
      if(tickets.length === 0){
        ticketsList.innerHTML = '<div class="muted">No hay tickets guardados</div>';
        updateCorrelativeDisplay();
        updatePreview();
        return;
      }
      // Show only sale tickets in the selection (but both types exist)
      const saleTickets = tickets.filter(t => t.type === 'sale');
      saleTickets.slice().reverse().forEach(t=>{
        const div = document.createElement('div');
        div.style.borderBottom='1px solid #eee';
        div.style.padding='8px 0';
        div.innerHTML = `
          <input type="radio" name="ticket_radio" value="${t.id}" id="r_${t.id}" />
          <label for="r_${t.id}"><strong>${t.id}</strong> - ${t.dateFormatted} - Q${t.total.toFixed(2)} - ${t.paymentMethod}</label>
          <div class="muted">${t.generalComment || ''}</div>
        `;
        ticketsList.appendChild(div);
      });
      updateCorrelativeDisplay();
      updatePreview();
    }

    function updateCorrelativeDisplay(){
      const next = getNextNumber();
      correlativeDisplay.textContent = `A${next}`;
    }

    // Open ticket details in preview
    function openTicketDetails(ticket){
      preview.innerHTML = renderTicketHTML(ticket, false);
    }

    /* ======= Printing helpers: open window with ticket HTML then print ======= */

    // Templates: sale and kitchen; use logo.png for sale; use inline chef SVG for kitchen
    function printSaleTicket(ticket){
      const win = window.open('', '_blank', 'width=400,height=800');
      const html = `
        <!doctype html>
        <html>
          <head>
            <meta charset="utf-8" />
            <title>Ticket Venta ${ticket.id}</title>
            <style>
              body{font-family: Arial, Helvetica, sans-serif;padding:6px;margin:0;}
              .ticket{width:76mm; /* slightly less than 80 */ }
              .center{text-align:center}
              img.logo{max-width:72mm;height:auto;display:block;margin:0 auto 6px}
              .company{font-weight:700;font-size:14px}
              .muted{font-size:12px;color:#333}
              .order{font-size:16px;font-weight:700;margin:6px 0}
              table{width:100%;border-collapse:collapse;font-size:12px}
              th,td{padding:4px;text-align:left}
              .price{text-align:right}
              .total{font-size:16px;font-weight:700;border-top:1px solid #000;padding-top:6px}
              .small{font-size:11px}
              .footer{margin-top:6px;text-align:center;font-size:12px}
              .no-break { page-break-inside: avoid; }
            </style>
          </head>
          <body onload="setTimeout(()=>{window.print();},300)">
            <div class="ticket">
              <!-- logo.png debe estar en la misma carpeta -->
              <img src="logo.png" class="logo" alt="Logo" onerror="this.style.display='none'"/>
              <div class="center company">TORTILLAS DE HARINA LAS PICONAS</div>
              <div class="center muted">EVENTOS</div>
              <div class="center muted">ENCUENTRANOS EN: ZONA 17, ROOSEVELT Y SAN CRISTOBAL</div>
              <div style="height:6px"></div>
              <div class="center muted">${escapeHtml(ticket.dateFormatted)}</div>

              <div class="order center">SU ORDEN ES &nbsp; <span style="font-size:20px">${escapeHtml(ticket.id)}</span></div>

              <div class="center" style="font-size:18px;font-weight:700">DETALLE DE CONSUMO</div>

              <table>
                <thead>
                  <tr><th>PRODUCTO</th><th class="price">PRECIO</th></tr>
                </thead>
                <tbody>
                  ${ticket.items.map(it=>`<tr><td>${it.qty} x ${escapeHtml(it.name)}</td><td class="price">Q${(it.price*it.qty).toFixed(2)}</td></tr>`).join('')}
                </tbody>
              </table>

              <div class="total">TOTAL &nbsp; Q${ticket.total.toFixed(2)}</div>

              <div style="margin-top:6px" class="small">Forma de pago: ${escapeHtml(ticket.paymentMethod)}</div>
              ${ticket.generalComment ? `<div class="small">Comentario: ${escapeHtml(ticket.generalComment)}</div>` : ''}
              <div class="footer">Gracias por su compra</div>
            </div>
          </body>
        </html>
      `;
      win.document.write(html);
      win.document.close();
    }

    function printKitchenTicket(ticket){
      const win = window.open('', '_blank', 'width=400,height=800');
      const chefSVG = getChefSVGBase64();
      const html = `
        <!doctype html>
        <html>
          <head>
            <meta charset="utf-8" />
            <title>Comanda Cocina ${ticket.id}</title>
            <style>
              body{font-family: Arial, Helvetica, sans-serif;padding:6px;margin:0;}
              .ticket{width:76mm;}
              .center{text-align:center}
              img.logo{max-width:60mm;height:auto;display:block;margin:0 auto 6px}
              .company{font-weight:700;font-size:14px}
              .muted{font-size:12px;color:#333}
              .order{font-size:16px;font-weight:700;margin:6px 0}
              table{width:100%;border-collapse:collapse;font-size:14px}
              th,td{padding:4px;text-align:left}
              .small{font-size:11px}
              .items{margin-top:4px}
              .item-row{border-bottom:1px dashed #000;padding:4px 0}
            </style>
          </head>
          <body onload="setTimeout(()=>{window.print();},300)">
            <div class="ticket">
              <div class="center"><img src="${chefSVG}" class="logo" alt="Chef" /></div>
              <div class="center company">COCINA - COMANDA</div>
              <div class="center muted">${escapeHtml(ticket.dateFormatted)}</div>
              <div style="height:6px"></div>
              <div class="order center">ORDEN NO. <span style="font-size:20px">${escapeHtml(ticket.id)}</span></div>

              ${ticket.generalComment ? `<div class="small">Comentario general: ${escapeHtml(ticket.generalComment)}</div>` : ''}

              <div class="items">
                ${ticket.items.map(it=>`<div class="item-row">${it.qty} x ${escapeHtml(it.name)} ${it.comment?`<div class="small">(${escapeHtml(it.comment)})</div>`:''}</div>`).join('')}
              </div>

              <div style="margin-top:8px" class="small center">--- FIN COMANDA ---</div>
            </div>
          </body>
        </html>
      `;
      win.document.write(html);
      win.document.close();
    }

    function printCloseTicket(cierre){
      const win = window.open('', '_blank', 'width=400,height=800');
      const html = `
        <!doctype html>
        <html>
          <head>
            <meta charset="utf-8" />
            <title>Cierre de Ventas</title>
            <style>
              body{font-family: Arial, Helvetica, sans-serif;padding:6px;margin:0;}
              .ticket{width:76mm;}
              .center{text-align:center}
              .company{font-weight:700;font-size:14px}
              table{width:100%;border-collapse:collapse;font-size:12px}
              th,td{padding:4px;text-align:left}
              .total{font-size:16px;font-weight:700;margin-top:6px}
            </style>
          </head>
          <body onload="setTimeout(()=>{window.print();},300)">
            <div class="ticket">
              <div class="center company">CIERRE DE VENTAS</div>
              <div class="center muted">${new Date(cierre.date).toLocaleString()}</div>
              <table>
                <tr><td>Total Efectivo</td><td style="text-align:right">Q${cierre.totalEfectivo.toFixed(2)}</td></tr>
                <tr><td>Total Tarjeta</td><td style="text-align:right">Q${cierre.totalTarjeta.toFixed(2)}</td></tr>
                <tr><td><strong>Total General</strong></td><td style="text-align:right"><strong>Q${cierre.totalGeneral.toFixed(2)}</strong></td></tr>
              </table>
              <div style="margin-top:8px">Tickets incluidos:</div>
              <div>
                ${cierre.tickets.map(t=>`<div style="font-size:12px">${escapeHtml(t.id)} - ${escapeHtml(t.date)} - Q${t.total.toFixed(2)} - ${escapeHtml(t.paymentMethod)}</div>`).join('')}
              </div>
              <div style="margin-top:12px" class="center small">--- FIN CIERRE ---</div>
            </div>
          </body>
        </html>
      `;
      win.document.write(html);
      win.document.close();
    }

    // Chef SVG generator (returns data URL)
    function getChefSVGBase64(){
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 64 64'>
        <g fill='none' fill-rule='evenodd'>
          <circle cx='32' cy='22' r='10' fill='#FFD966'/>
          <path d='M20 38c0-7 12-10 12-10s12 3 12 10v10H20V38z' fill='#F4A261'/>
          <path d='M18 24c0-7.7 6.3-14 14-14s14 6.3 14 14' stroke='#333' stroke-width='0.8' fill='none'/>
          <path d='M24 20c1 1.5 3 2 4 0' stroke='#333' stroke-width='0.8' stroke-linecap='round'/>
          <path d='M40 20c-1 1.5-3 2-4 0' stroke='#333' stroke-width='0.8' stroke-linecap='round'/>
          <path d='M26 22c.8 1.2 2 1.6 3 1.6s2.2-.4 3-1.6' stroke='#333' stroke-width='0.8' stroke-linecap='round' stroke-linejoin='round'/>
          <path d='M36 10c0 0 4-6 12-4 6 1.5 6 6 6 8 0 0-2-2-6-2-4 0-11 2-12-2z' fill='#fff' stroke='#333' stroke-width='0.6'/>
        </g>
      </svg>`;
      return 'data:image/svg+xml;base64,' + btoa(svg);
    }

    /* ======= Utility: Format date/time ======= */
    function pad(n){ return n < 10 ? '0' + n : n; }
    function formatDateTime(d){
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    /* ======= Render ticket HTML for preview (light) ======= */
    function renderTicketHTML(ticket, forPrint = false){
      if(!ticket) return '<div class="muted">Sin ticket</div>';
      let html = `<div><strong>Ticket ${escapeHtml(ticket.id)}</strong> - ${escapeHtml(ticket.dateFormatted)}</div>`;
      html += `<div>Forma: ${escapeHtml(ticket.paymentMethod)}</div>`;
      html += `<div style="margin-top:6px"><strong>Items:</strong></div>`;
      html += '<ul>';
      ticket.items.forEach(it=>{
        html += `<li>${it.qty} x ${escapeHtml(it.name)} ${it.comment?` - <em>${escapeHtml(it.comment)}</em>`:''} ${it.price?` - Q${(it.price*it.qty).toFixed(2)}`:''}</li>`;
      });
      html += '</ul>';
      html += `<div class="total">TOTAL Q${(ticket.total||0).toFixed(2)}</div>`;
      if(ticket.generalComment) html += `<div class="muted">Comentario: ${escapeHtml(ticket.generalComment)}</div>`;
      return html;
    }

    function updatePreview(){
      const next = getNextNumber();
      const previewTicket = {
        id: `A${next}`,
        dateFormatted: formatDateTime(new Date()),
        items: cart,
        paymentMethod: paymentMethod.value,
        total: cart.reduce((s,i)=>s+(i.qty * i.price),0),
        generalComment: generalComment.value
      };
      preview.innerHTML = renderTicketHTML(previewTicket);
      updateCorrelativeDisplay();
    }

    /* ======= Open ticket details popup (simple) ======= */
    function openTicketPopup(ticket){
      const w = window.open('', '_blank', 'width=480,height=640');
      w.document.write('<html><head><meta charset="utf-8"><title>Detalle ticket</title></head><body>');
      w.document.write(renderTicketHTML(ticket,true));
      w.document.write('</body></html>');
      w.document.close();
    }

    /* ======= On load: render stored tickets, set listeners ======= */
    function init(){
      updateTicketsList();
      renderCart();
    }
    init();

    // helper to escape for the new windows too
    window.escapeHtml = escapeHtml;

  </script>
</body>
</html>

